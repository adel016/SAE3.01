    <!DOCTYPE html>
    <html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Tableau de Bord Météo</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link rel="stylesheet" href="<?= \App\Meteo\Config\Conf::getBaseUrl(); ?>/Assets/css/index.css">
        <style>
            /* Ajoute tes styles CSS ici */
            .dropdown {
                position: relative;
                display: inline-block;
            }

            .dropdown-content {
                display: none;
                position: absolute;
                background-color: #f9f9f9;
                min-width: 160px;
                box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
                z-index: 1;
            }

            .dropdown-content a {
                color: black;
                padding: 12px 16px;
                text-decoration: none;
                display: block;
            }

            .dropdown-content a:hover {
                background-color: #f1f1f1;
            }

            .dropdown:hover .dropdown-content {
                display: block;
            }

            .dropdown:hover .dropbtn {
                background-color: #3e8e41;
            }

            .dropbtn {
                text-decoration: none;
                color: #004080;
                background-color: rgba(255, 255, 255, 0.7);
                border: 2px solid #004080;
                border-radius: 5px;
                padding: 10px 15px;
                margin: 0 5px;
                transition: transform 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            }

            .dropbtn:hover {
                transform: scale(1.1);
                background-color: #004080;
                color: #FFFFFF;
            }
        </style>
    </head>
    <body>
        <header>
            <nav class="navbar">
                <a href="<?= \App\Meteo\Config\Conf::getBaseUrl(); ?>/Web/frontController.php" class="title">MeteoVision</a>
        
                <!-- Bouton Tableau de bord avec menu déroulant -->
                <div class="dropdown">
                    <a href="#" class="dropbtn">Tableau de bord</a>
                    <div class="dropdown-content">
                        <a href="<?= \App\Meteo\Config\Conf::getBaseUrl(); ?>/Web/frontController.php?action=index&controller=tableauDeBord">Recherche graphique</a>
                        <a href="<?= \App\Meteo\Config\Conf::getBaseUrl(); ?>/Web/frontController.php?action=rechercheAvancee&controller=tableauDeBord">Recherche libre</a>
                    </div>
                </div>
        
                <a href="<?= \App\Meteo\Config\Conf::getBaseUrl(); ?>/Web/frontController.php?action=default&controller=api">Observations</a>
                <a href="#">Contact</a>
        
                <?php if (isset($_SESSION['utilisateur_id'])): ?>
                    <div class="user-info">
                        <span class="user-name">
                            <?php if (isset($_SESSION['role']) && $_SESSION['role'] === 'utilisateur'): ?>
                                <a href="<?= \App\Meteo\Config\Conf::getBaseUrl(); ?>/Web/frontController.php?action=readAll&controller=utilisateur">
                                    <?= isset($_SESSION['prenom']) ? htmlspecialchars($_SESSION['prenom']) : '' ?>
                                    <?= isset($_SESSION['nom']) ? htmlspecialchars($_SESSION['nom']) : '' ?>
                                </a>
                            <?php endif; ?>
                        </span>
        
                        <!-- Vérification si l'utilisateur est admin pour afficher le bouton "Tableau de bord admin" -->
                        <?php if (isset($_SESSION['role']) && $_SESSION['role'] === 'admin'): ?>
                            <a href="<?= \App\Meteo\Config\Conf::getBaseUrl(); ?>/Web/frontController.php?action=tableauDeBord&controller=admin" class="admin-dashboard-link">
                                Tableau de bord admin
                            </a>
                        <?php endif; ?>
        
                        <a href="<?= \App\Meteo\Config\Conf::getBaseUrl(); ?>/Web/frontController.php?action=deconnexion&controller=utilisateur" class="logout-link">
                            Déconnexion
                        </a>
                    </div>
                <?php else: ?>
                    <a href="<?= \App\Meteo\Config\Conf::getBaseUrl(); ?>/Web/frontController.php?action=connexion&controller=utilisateur" class="compte-lien">
                        <img src="<?= \App\Meteo\Config\Conf::getBaseUrl(); ?>/Assets/img/compte_logo.png" alt="LOGO DE COMPTE" class="compte-image">
                    </a>
                <?php endif; ?>
            </nav>
        </header>
        

        <h1 style="margin-top: 20px; text-align: center; font-size: 2rem;">Tableau de Bord Météo</h1>

    <!-- Filtres de recherche -->
    <div style="margin: 20px;">
        <label for="libgeo">Ville :</label>
        <input type="text" id="libgeo" placeholder="Ex : ORLY"><br>

        <label for="nom_dept">Département :</label>
        <input type="text" id="nom_dept" placeholder="Ex : Essonne"><br>

        <label for="region">Région :</label>
        <input type="text" id="region" placeholder="Ex : Île-de-France"><br>

        <label for="codegeo">Code Postal :</label>
        <input type="text" id="codegeo" placeholder="Ex : 91"><br>

        <label for="date_debut">Date Début :</label>
        <input type="date" id="date_debut"><br>

        <label for="date_fin">Date Fin :</label>
        <input type="date" id="date_fin"><br>

        <!-- Choix de la granularité temporelle -->
        <select id="granulariteSelect">
            <option value="year">Année</option>
            <option value="month">Mois</option>
            <option value="week">Semaine</option>
            <option value="day">Jour</option>
        </select><br>

        <!-- Choix de données à afficher -->
        <label for="tempCheckbox">Afficher la température :</label>
        <input type="checkbox" id="tempCheckbox" checked><br>

        <label for="humidityCheckbox">Afficher l'humidité :</label>
        <input type="checkbox" id="humidityCheckbox"><br>

        <label for="windSpeedCheckbox">Afficher la vitesse du vent :</label>
        <input type="checkbox" id="windSpeedCheckbox"><br>

        <button onclick="fetchData()" style="margin-top: 20px;">Rechercher</button>
    </div>

    <h3 style="margin-top: 20px; text-align: center;">Graphique des données sélectionnées :</h3>
    <div id="weatherChartContainer" style="margin: 20px;">
        <canvas id="weatherChart"></canvas>
    </div>

    <!-- Tableau des résultats -->
    <table id="result-table" style="display: none; margin: 20px;">
        <thead>
            <tr>
                <th>Date</th>
                <th>Température (°C)</th>
                <th>Humidité (%)</th>
                <th>Vitesse du vent (km/h)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

        <script>
            let chart = null; // Variable pour stocker le graphique

            function displayChart(labels, tempData, humidityData, windSpeedData) {
                const ctx = document.getElementById('weatherChart').getContext('2d');

                // Si un graphique existe déjà, le détruire avant de créer un nouveau
                if (chart) {
                    chart.destroy();
                }

                // Préparer les datasets
                const datasets = [];

                // Vérifier si la température est sélectionnée
                if (document.getElementById('tempCheckbox').checked) {
                    datasets.push({
                        label: 'Température (°C)', // Titre de la série
                        data: tempData, // Données de la température
                        fill: false,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(75, 192, 192, 1)',
                        tension: 0.4
                    });
                }

                // Vérifier si l'humidité est sélectionnée
                if (document.getElementById('humidityCheckbox').checked) {
                    datasets.push({
                        label: 'Humidité (%)', // Titre de la série
                        data: humidityData, // Données de l'humidité
                        fill: false,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(153, 102, 255, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(153, 102, 255, 1)',
                        tension: 0.4
                    });
                }

                // Vérifier si la vitesse du vent est sélectionnée
                if (document.getElementById('windSpeedCheckbox').checked) {
                    datasets.push({
                        label: 'Vitesse du vent (km/h)', // Titre de la série
                        data: windSpeedData, // Données de la vitesse du vent
                        fill: false,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(255, 99, 132, 1)',
                        tension: 0.4
                    });
                }

                // Créer un nouveau graphique
                chart = new Chart(ctx, {
                    type: 'line', // Type de graphique (ici, une courbe)
                    data: {
                        labels: labels, // Labels (dates, etc.)
                        datasets: datasets // Séries de données (température, humidité et/ou vitesse du vent)
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Valeur',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleFont: {
                                    size: 14
                                },
                                bodyFont: {
                                    size: 12
                                }
                            }
                        },
                        elements: {
                            line: {
                                borderWidth: 2
                            },
                            point: {
                                radius: 4,
                                hoverRadius: 6
                            }
                        }
                    }
                });
            }

            // Fonction pour récupérer et afficher les résultats
            function fetchData() {
                const libgeo = document.getElementById('libgeo').value;
                const region = document.getElementById('region').value;
                const nom_dept = document.getElementById('nom_dept').value;
                const codegeo = document.getElementById('codegeo').value;
                const date_debut = document.getElementById('date_debut').value;
                const date_fin = document.getElementById('date_fin').value;

                // Récupérer le choix de la granularité
                const granularite = document.getElementById('granulariteSelect').value;

                let adjustedDateDebut = date_debut;
                let adjustedDateFin = date_fin;

                if (granularite === 'month' && date_debut) {
                    // Si la granularité est mensuelle, ajuster date_fin au dernier jour du mois
                    const debutDate = new Date(date_debut);
                    adjustedDateFin = new Date(debutDate.getFullYear(), debutDate.getMonth() + 1, 0).toISOString().split('T')[0];
                } else if (granularite === 'week' && date_debut) {
                    // Si la granularité est hebdomadaire, ajuster date_fin à 7 jours après date_debut
                    const debutDate = new Date(date_debut);
                    adjustedDateFin = new Date(debutDate.getTime() + 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                } else if (granularite === 'day' && date_debut) {
                    // Si la granularité est journalière, ajuster la date de fin pour couvrir une seule journée
                    adjustedDateFin = new Date(new Date(date_debut).getTime() + 24 * 60 * 60 * 1000 - 1).toISOString().split('T')[0];
                }

                // Construire l'URL avec la date ajustée si nécessaire
                const url = `recherche_avancee.php?libgeo=${encodeURIComponent(libgeo)}&region=${encodeURIComponent(region)}&nom_dept=${encodeURIComponent(nom_dept)}&codegeo=${encodeURIComponent(codegeo)}&date_debut=${adjustedDateDebut}&date_fin=${adjustedDateFin}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Data received:', data); // Ajout d'un log pour déboguer
                        displayResults(data, granularite); // Passer la granularité au moment de l'affichage
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("Erreur lors de la récupération des données.");
                    });
            }

            function displayResults(data, granularite) {
                const table = document.getElementById('result-table');
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = ''; // Efface les résultats précédents

                if (data && data.results && data.results.length > 0) {
                    table.style.display = 'table'; // Affiche le tableau
                    let results = data.results;

                    // Trier les résultats par date en ordre croissant
                    results.sort((a, b) => new Date(a.date) - new Date(b.date));

                    if (granularite === 'year') {
                        const monthlyData = {};

                        // Grouper les données par mois
                        results.forEach(record => {
                            const date = new Date(record.date);
                            const month = date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0'); // Format YYYY-MM
                            if (!monthlyData[month]) {
                                monthlyData[month] = { temp: [], humidity: [], windSpeed: [] };
                            }
                            monthlyData[month].temp.push(record.tc); // Température
                            monthlyData[month].humidity.push(record.u); // Humidité
                            monthlyData[month].windSpeed.push(record.ff); // Vitesse du vent
                        });

                        // Calculer les moyennes mensuelles et afficher les données
                        Object.keys(monthlyData).sort().forEach(month => {
                            const row = document.createElement('tr');
                            const avgTemp = Math.round(monthlyData[month].temp.reduce((a, b) => a + b, 0) / monthlyData[month].temp.length);
                            const avgHumidity = (monthlyData[month].humidity.reduce((a, b) => a + b, 0) / monthlyData[month].humidity.length).toFixed(2);
                            const avgWindSpeed = (monthlyData[month].windSpeed.reduce((a, b) => a + b, 0) / monthlyData[month].windSpeed.length).toFixed(2);

                            row.innerHTML = `
                                <td>${month}</td>
                                <td>${avgTemp}</td>
                                <td>${avgHumidity}</td>
                                <td>${avgWindSpeed}</td>
                            `;
                            tbody.appendChild(row);
                        });

                        // Préparer les données pour le graphique
                        const labels = Object.keys(monthlyData).sort();
                        const tempData = labels.map(month => Math.round(monthlyData[month].temp.reduce((a, b) => a + b, 0) / monthlyData[month].temp.length));
                        const humidityData = labels.map(month => (monthlyData[month].humidity.reduce((a, b) => a + b, 0) / monthlyData[month].humidity.length).toFixed(2));
                        const windSpeedData = labels.map(month => (monthlyData[month].windSpeed.reduce((a, b) => a + b, 0) / monthlyData[month].windSpeed.length).toFixed(2));

                        displayChart(labels, tempData, humidityData, windSpeedData);
                    } else if (granularite === 'month' || granularite === 'week') {
                        const dailyData = {};

                        results.forEach(record => {
                            const date = record.date.split('T')[0];
                            if (!dailyData[date]) {
                                dailyData[date] = { temp: [], humidity: [], windSpeed: [] };
                            }
                            dailyData[date].temp.push(record.tc); // Température
                            dailyData[date].humidity.push(record.u); // Humidité
                            dailyData[date].windSpeed.push(record.ff); // Vitesse du vent
                        });

                        Object.keys(dailyData).sort().forEach(date => {
                            const row = document.createElement('tr');
                            const avgTemp = Math.round(dailyData[date].temp.reduce((a, b) => a + b, 0) / dailyData[date].temp.length);
                            const avgHumidity = (dailyData[date].humidity.reduce((a, b) => a + b, 0) / dailyData[date].humidity.length).toFixed(2);
                            const avgWindSpeed = (dailyData[date].windSpeed.reduce((a, b) => a + b, 0) / dailyData[date].windSpeed.length).toFixed(2);

                            row.innerHTML = `
                                <td>${date}</td>
                                <td>${avgTemp}</td>
                                <td>${avgHumidity}</td>
                                <td>${avgWindSpeed}</td>
                            `;
                            tbody.appendChild(row);
                        });

                        const labels = Object.keys(dailyData).sort();
                        const tempData = labels.map(date => Math.round(dailyData[date].temp.reduce((a, b) => a + b, 0) / dailyData[date].temp.length));
                        const humidityData = labels.map(date => (dailyData[date].humidity.reduce((a, b) => a + b, 0) / dailyData[date].humidity.length).toFixed(2));
                        const windSpeedData = labels.map(date => (dailyData[date].windSpeed.reduce((a, b) => a + b, 0) / dailyData[date].windSpeed.length).toFixed(2));

                        displayChart(labels, tempData, humidityData, windSpeedData);
                    } else if (granularite === 'day') {
                        const hourlyData = {};

                        results.forEach(record => {
                            const time = record.date.split('T')[1].split(':')[0];
                            if (!hourlyData[time]) {
                                hourlyData[time] = { temp: [], humidity: [], windSpeed: [] };
                            }
                            hourlyData[time].temp.push(record.tc);
                            hourlyData[time].humidity.push(record.u);
                            hourlyData[time].windSpeed.push(record.ff);
                        });

                        Object.keys(hourlyData).sort().forEach(hour => {
                            const row = document.createElement('tr');
                            const avgTemp = Math.round(hourlyData[hour].temp.reduce((a, b) => a + b, 0) / hourlyData[hour].temp.length);
                            const avgHumidity = (hourlyData[hour].humidity.reduce((a, b) => a + b, 0) / hourlyData[hour].humidity.length).toFixed(2);
                            const avgWindSpeed = (hourlyData[hour].windSpeed.reduce((a, b) => a + b, 0) / hourlyData[hour].windSpeed.length).toFixed(2);

                            row.innerHTML = `
                                <td>${hour.padStart(2, '0')}h00</td>
                                <td>${avgTemp}</td>
                                <td>${avgHumidity}</td>
                                <td>${avgWindSpeed}</td>
                            `;
                            tbody.appendChild(row);
                        });

                        const labels = Object.keys(hourlyData).sort().map(hour => `${hour.padStart(2, '0')}h00`);
                        const tempData = labels.map((_, i) => Math.round(hourlyData[Object.keys(hourlyData).sort()[i]].temp.reduce((a, b) => a + b, 0) / hourlyData[Object.keys(hourlyData).sort()[i]].temp.length));
                        const humidityData = labels.map((_, i) => (hourlyData[Object.keys(hourlyData).sort()[i]].humidity.reduce((a, b) => a + b, 0) / hourlyData[Object.keys(hourlyData).sort()[i]].humidity.length).toFixed(2));
                        const windSpeedData = labels.map((_, i) => (hourlyData[Object.keys(hourlyData).sort()[i]].windSpeed.reduce((a, b) => a + b, 0) / hourlyData[Object.keys(hourlyData).sort()[i]].windSpeed.length).toFixed(2));

                        displayChart(labels, tempData, humidityData, windSpeedData);
                    } else {
                        results.forEach(record => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${record.date}</td>
                                <td>${Math.round(record.tc)}</td> <!-- Température arrondie -->
                                <td>${record.u}</td>
                                <td>${record.ff}</td>
                            `;
                            tbody.appendChild(row);
                        });

                        const labels = results.map(record => record.date);
                        const tempData = results.map(record => Math.round(record.tc)); // Température arrondie
                        const humidityData = results.map(record => record.u);
                        const windSpeedData = results.map(record => record.ff);

                        displayChart(labels, tempData, humidityData, windSpeedData);
                    }
                } else {
                    table.style.display = 'none'; // Cache le tableau si aucune donnée
                    alert('Aucun résultat trouvé.');
                }
            }
        </script>
    </body>
    </html>
